name: 🔑 Generate Secure Daily Key

on:
  schedule:
    - cron: '0 16 * * *'  # 16:00 UTC = 23:00 VN
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-key:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate and Encrypt Daily Data
      run: |
        # Lấy secret key từ GitHub Secrets
        SECRET_KEY="${{ secrets.AES_SECRET_KEY }}"
        if [ -z "$SECRET_KEY" ]; then
          echo "Lỗi: Biến AES_SECRET_KEY chưa được thiết lập trong GitHub Secrets!"
          exit 1
        fi
        
        # THAY ĐỔI 1: Key bắt đầu bằng "vphuc_"
        TOMORROW=$(date +%Y%m%d)
        RAW_KEY="vphuc_${TOMORROW}_$(openssl rand -hex 6 | tr '[:lower:]' '[:upper:]')"
        
        # Lấy link từ một dịch vụ pastebin (ví dụ: paste.ee)
        PASTE_RESPONSE=$(curl -s -X POST "https://api.paste.ee/v1/pastes" \
          -H "Content-Type: application/json" \
          -d "{\"sections\":[{\"contents\":\"$RAW_KEY\"}]}")
        PASTE_URL=$(echo "$PASTE_RESPONSE" | grep -o '"link":"[^"]*' | cut -d'"' -f4)
        
        # THAY ĐỔI 2: Xử lý lỗi nếu pastebin không thành công
        if [ -z "$PASTE_URL" ]; then
          echo "Lỗi Tạo Key: Không thể tạo link trên paste.ee."
          echo "Phản hồi từ API: $PASTE_RESPONSE"
          exit 1
        fi
        
        # Rút gọn link qua API Yeumoney
        YEUMONEY_TOKEN="3d4f42d51d76e19546544bc715b3c65888005a6300d9f599a3f89183066b052f"
        ENCODED_PASTE_URL=$(echo "$PASTE_URL" | sed 's/&/%26/g; s/?/%3F/g; s/:/%3A/g; s/\//%2F/g')
        RESPONSE=$(curl -s "https://yeumoney.com/QL_api.php?token=$YEUMONEY_TOKEN&url=$ENCODED_PASTE_URL")
        SHORT_URL="$RESPONSE"

        # THAY ĐỔI 2 (tiếp): Xử lý lỗi nếu Yeumoney không thành công
        if [ -z "$SHORT_URL" ] || [[ "$SHORT_URL" == *"error"* ]] || [[ "$SHORT_URL" == *"Error"* ]] || ! [[ "$SHORT_URL" == "http"* ]]; then
          echo "Lỗi Tạo Key: Không thể rút gọn link qua Yeumoney."
          echo "Phản hồi từ API: $RESPONSE"
          exit 1
        fi
        
        # Chuẩn bị dữ liệu JSON
        PLAINTEXT_JSON="{\"key\":\"$RAW_KEY\",\"date\":\"$TOMORROW\",\"short_url\":\"$SHORT_URL\"}"

        # Mã hóa dữ liệu
        IV=$(openssl rand -hex 16)
        HEX_KEY=$(echo -n "$SECRET_KEY" | xxd -p -c 256)
        ENCRYPTED_DATA=$(echo -n "$PLAINTEXT_JSON" | openssl enc -aes-256-cbc -K "$HEX_KEY" -iv "$IV" -base64 -A)
        
        # THAY ĐỔI 3: Xuất ra file "daily-key.json"
        echo '{"data":"'$ENCRYPTED_DATA'","iv":"'$IV'"}' > daily-key.json

        # Commit và push file đã mã hóa lên repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add daily-key.json
        git commit -m "Auto: Encrypted daily key for $TOMORROW"
        git push
