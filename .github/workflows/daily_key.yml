name: ğŸ”‘ Generate Secure Daily Key

on:
  schedule:
    - cron: '0 16 * * *'  # 16:00 UTC = 23:00 VN
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-key:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Generate and Encrypt Daily Data
      run: |
        # Láº¥y secret key tá»« GitHub Secrets
        SECRET_KEY="${{ secrets.AES_SECRET_KEY }}"
        if [ -z "$SECRET_KEY" ]; then
          echo "Lá»—i: Biáº¿n AES_SECRET_KEY chÆ°a Ä‘Æ°á»£c thiáº¿t láº­p trong GitHub Secrets!"
          exit 1
        fi
        
        # Táº¡o key cho NGÃ€Y MAI (theo giá» Viá»‡t Nam)
        TOMORROW=$(date -d "+1 day" +%Y%m%d)
        RAW_KEY="comment_${TOMORROW}_$(openssl rand -hex 6 | tr '[:lower:]' '[:upper:]')"
        
        # Láº¥y link tá»« má»™t dá»‹ch vá»¥ pastebin (vÃ­ dá»¥: paste.ee)
        PASTE_RESPONSE=$(curl -s -X POST "https://api.paste.ee/v1/pastes" \
          -H "Content-Type: application/json" \
          -d "{\"sections\":[{\"contents\":\"$RAW_KEY\"}]}")
        PASTE_URL=$(echo "$PASTE_RESPONSE" | grep -o '"link":"[^"]*' | cut -d'"' -f4)
        
        # Fallback náº¿u pastebin lá»—i
        if [ -z "$PASTE_URL" ]; then
          PASTE_URL="https://www.google.com/search?q=$RAW_KEY"
        fi
        
        # RÃºt gá»n link (API cá»§a báº¡n)
        RESPONSE=$(curl -s "https://link4m.co/api-shorten/v2?api=68db842cd32fc747763d594d&url=$PASTE_URL")
        SHORT_URL=$(echo "$RESPONSE" | grep -o '"shortenedUrl":"[^"]*' | cut -d'"' -f4)

        # Chuáº©n bá»‹ dá»¯ liá»‡u JSON á»Ÿ dáº¡ng text thÆ°á»ng
        PLAINTEXT_JSON="{\"key\":\"$RAW_KEY\",\"date\":\"$TOMORROW\",\"short_url\":\"$SHORT_URL\"}"

        # --- Báº®T Äáº¦U MÃƒ HÃ“A Dá»® LIá»†U ---
        # Táº¡o má»™t IV (Initialization Vector) ngáº«u nhiÃªn, cáº§n thiáº¿t cho viá»‡c giáº£i mÃ£
        IV=$(openssl rand -hex 16)
        
        # MÃ£ hÃ³a dá»¯ liá»‡u JSON báº±ng thuáº­t toÃ¡n AES-256-CBC, sau Ä‘Ã³ encode Base64
        # Openssl yÃªu cáº§u key vÃ  iv pháº£i á»Ÿ dáº¡ng hex
        HEX_KEY=$(echo -n "$SECRET_KEY" | xxd -p -c 256)

        # =================================================================================
        # THAY Äá»”I DUY NHáº¤T: ThÃªm cá» '-A' á»Ÿ cuá»‘i lá»‡nh openssl Ä‘á»ƒ ngÄƒn nÃ³ xuá»‘ng dÃ²ng
        ENCRYPTED_DATA=$(echo -n "$PLAINTEXT_JSON" | openssl enc -aes-256-cbc -K "$HEX_KEY" -iv "$IV" -base64 -A)
        # =================================================================================
        
        # Táº¡o file JSON cuá»‘i cÃ¹ng vá»›i dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a vÃ  IV
        echo "{\"data\":\"$ENCRYPTED_DATA\",\"iv\":\"$IV\"}" > daily-key_comment.json
        # --- Káº¾T THÃšC MÃƒ HÃ“A ---

        # Commit vÃ  push file Ä‘Ã£ mÃ£ hÃ³a lÃªn repo
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add daily-key_comment.json
        git commit -m "Auto: Encrypted daily key for $TOMORROW"
        git push
